# 🛡️ 高级风险管理系统

## 📋 完整风险管理架构

### 你的需求

1. **Portfolio风险计算** - 适配新的投资组合模式
2. **实时监控** - 滑点、流动性、异常行为
3. **自动停止机制** - 根据情况停止Trading Agent
4. **前端展示** - 所有风险指标可视化

### ✅ 已实现

## 🏗️ Risk Agent架构

```
┌──────────────────────────────────────────────────────────────┐
│  Advanced Risk Agent                                          │
│  🛡️ 实时风险监控与管理                                        │
└──────────────────────────────────────────────────────────────┘

├─ Portfolio风险计算 ─────────────────────────────────────────┐
│  传统风险指标:                                                │
│    • VaR (95%, 99%)     - Value at Risk                     │
│    • CVaR (95%, 99%)    - Conditional VaR                   │
│    • Sharpe Ratio       - 风险调整收益                       │
│    • Sortino Ratio      - 下行风险调整收益                    │
│    • Max Drawdown       - 最大回撤                           │
│    • Calmar Ratio       - 收益/回撤比                        │
│                                                               │
│  Portfolio特定指标:                                           │
│    • Portfolio Volatility    - 投资组合波动率                │
│    • Correlation Risk        - 相关性风险                    │
│    • Concentration Risk      - 集中度风险                    │
│    • Diversification Ratio   - 分散化比率                    │
└───────────────────────────────────────────────────────────────┘

├─ 实时监控 ──────────────────────────────────────────────────┐
│  1️⃣ 滑点监控 (Slippage Monitoring)                           │
│     监控: 每笔交易的实际价格 vs 预期价格                       │
│     指标:                                                     │
│       • 滑点(bps) = |实际价格 - 预期价格| / 预期价格 * 10000  │
│       • 平均滑点                                              │
│       • 最大滑点                                              │
│       • 违规次数                                              │
│     阈值:                                                     │
│       • 警告: 30 bps (0.3%)                                  │
│       • 临界: 50 bps (0.5%)                                  │
│       • 触发暂停: 连续3次超过50 bps                           │
│                                                               │
│  2️⃣ 流动性监控 (Liquidity Monitoring)                         │
│     监控: 市场深度、价差、交易量                               │
│     指标:                                                     │
│       • Bid/Ask深度 (USD)                                    │
│       • 价差 (bps)                                           │
│       • 24h交易量 (USD)                                      │
│       • 流动性评分 (0-1)                                      │
│           = 0.4 * 深度评分 + 0.3 * 价差评分 + 0.3 * 交易量评分│
│     阈值:                                                     │
│       • 最小流动性: $50,000                                   │
│       • 最小评分: 0.5                                         │
│       • 最大价差: 100 bps (1%)                               │
│                                                               │
│  3️⃣ 异常检测 (Anomaly Detection)                              │
│     检测类型:                                                 │
│       a) 价格突变 (Price Spike)                              │
│          • 阈值: 15%价格变化 → 警告                          │
│          • 临界: 25%价格变化 → 暂停交易                      │
│                                                               │
│       b) 交易量异常 (Volume Anomaly)                         │
│          • 阈值: 3倍正常交易量 → 警告                         │
│          • 临界: 5倍正常交易量 → 暂停交易                     │
│                                                               │
│       c) 流动性骤降 (Liquidity Drain)                        │
│          • 阈值: 流动性下降50% → 暂停交易                    │
└───────────────────────────────────────────────────────────────┘

├─ 自动停止机制 ──────────────────────────────────────────────┐
│  触发条件:                                                    │
│    1. 滑点超标: 连续3次 > 50 bps                             │
│    2. 流动性不足: 评分 < 0.5                                 │
│    3. 价格异常: 变化 > 25%                                   │
│    4. 交易量异常: > 5倍正常值                                │
│    5. 流动性骤降: 下降 > 50%                                 │
│    6. Critical警报: 10分钟内3次Critical                      │
│                                                               │
│  停止流程:                                                    │
│    1. 检测到风险 → 生成Critical Alert                        │
│    2. 触发 trading_halted = True                             │
│    3. 记录暂停原因和时间                                      │
│    4. 阻止所有新交易                                         │
│    5. 发送通知到Dashboard                                    │
│                                                               │
│  恢复机制:                                                    │
│    • 手动恢复（不自动）                                      │
│    • 冷却时间: 10分钟                                        │
│    • 需要人工确认风险已解除                                  │
└───────────────────────────────────────────────────────────────┘

├─ 风险评分系统 ──────────────────────────────────────────────┐
│  综合风险评分 (0-1):                                         │
│    = VaR (25%)                                               │
│    + Volatility (20%)                                        │
│    + Slippage (15%)                                          │
│    + Liquidity Risk (20%)                                    │
│    + Concentration (15%)                                     │
│    + Anomaly Count (5%)                                      │
│                                                               │
│  风险等级:                                                    │
│    • 0.0 - 0.4: LOW     ✅ 安全                              │
│    • 0.4 - 0.6: MEDIUM  ⚠️  注意                             │
│    • 0.6 - 0.8: HIGH    🔶 警告                              │
│    • 0.8 - 1.0: CRITICAL 🚨 危险                             │
└───────────────────────────────────────────────────────────────┘
```

## 📊 前端展示 - Risk Dashboard

### Dashboard布局

```
┌─────────────────────────────────────────────────────────────┐
│  🛡️ Risk Management Dashboard                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─ 交易状态 ──────────────────────────────────────────┐   │
│  │ 🟢 Trading Active                                    │   │
│  │ 或                                                   │   │
│  │ 🔴 Trading Halted                                    │   │
│  │    原因: 高滑点风险                                  │   │
│  │    时间: 2025-10-23 14:30:25                         │   │
│  │    [Resume Trading] 按钮                             │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 实时风险指标 ──────────────────────────────────────┐   │
│  │                                                       │   │
│  │  综合风险评分: ████████░░ 0.58 (MEDIUM)              │   │
│  │                                                       │   │
│  │  Portfolio风险:                                      │   │
│  │    VaR (95%):     8.2%    ✅                         │   │
│  │    CVaR (95%):    11.5%   ⚠️                         │   │
│  │    Sharpe Ratio:  1.85    ✅                         │   │
│  │    Max Drawdown:  12.3%   ✅                         │   │
│  │    Volatility:    18.5%   ⚠️                         │   │
│  │                                                       │   │
│  │  滑点监控:                                           │   │
│  │    平均滑点:      18 bps  ✅                         │   │
│  │    最大滑点:      42 bps  ⚠️                         │   │
│  │    违规次数:      1       ⚠️                         │   │
│  │    [详细] 按钮                                       │   │
│  │                                                       │   │
│  │  流动性监控:                                         │   │
│  │    平均评分:      0.72    ✅                         │   │
│  │    最低评分:      0.58    ⚠️                         │   │
│  │    监控资产:      10      ✅                         │   │
│  │    [详细] 按钮                                       │   │
│  │                                                       │   │
│  │  异常检测:                                           │   │
│  │    总计:          2                                  │   │
│  │    Critical:      0       ✅                         │   │
│  │    High:          1       ⚠️                         │   │
│  │    Medium:        1       ⚠️                         │   │
│  │    [详细] 按钮                                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 风险图表 ──────────────────────────────────────────┐   │
│  │                                                       │   │
│  │  📈 Portfolio价值走势                                │   │
│  │     [折线图: 过去24小时]                             │   │
│  │                                                       │   │
│  │  📊 滑点分布                                         │   │
│  │     [柱状图: 各资产滑点对比]                         │   │
│  │                                                       │   │
│  │  🎯 流动性热图                                       │   │
│  │     [热图: 各资产流动性评分]                         │   │
│  │                                                       │   │
│  │  ⚡ 异常事件时间线                                   │   │
│  │     [时间线: 过去24小时的所有异常]                   │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 警报历史 ──────────────────────────────────────────┐   │
│  │ 时间              级别      类别      消息            │   │
│  │ ──────────────────────────────────────────────────  │   │
│  │ 14:32:15  🚨 CRITICAL  SLIPPAGE  BTC滑点52bps       │   │
│  │ 14:28:40  ⚠️  WARNING   LIQUIDITY ETH流动性0.48     │   │
│  │ 14:15:22  ⚠️  WARNING   ANOMALY   SOL价格+16%       │   │
│  │ 14:05:10  ℹ️  INFO      PORTFOLIO 风险评分0.62      │   │
│  │ ...                                                  │   │
│  │ [查看全部] [导出] 按钮                              │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 详细风险矩阵 ──────────────────────────────────────┐   │
│  │                                                       │   │
│  │  资产    VaR    滑点   流动性  异常  风险等级        │   │
│  │  ──────────────────────────────────────────────────  │   │
│  │  BTC    9.2%   42bps   0.78    0     MEDIUM          │   │
│  │  ETH    7.5%   25bps   0.65    1     MEDIUM          │   │
│  │  SOL    12.1%  18bps   0.52    2     HIGH            │   │
│  │  USDC   0.1%   5bps    0.95    0     LOW             │   │
│  │  ...                                                  │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─ 配置与控制 ──────────────────────────────────────────┐ │
│  │ 滑点阈值:    [30] bps (警告)  [50] bps (临界)        │ │
│  │ 流动性阈值:  [0.5] (最低评分)                        │ │
│  │ 异常阈值:    [15%] (价格) [3x] (交易量)              │ │
│  │                                                       │ │
│  │ [更新配置] [重置默认] [导出报告]                     │ │
│  └──────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 📊 所有风险指标详解

### 1. Portfolio风险指标

#### VaR (Value at Risk)
```
定义: 在给定置信水平下，投资组合的最大可能损失
计算: VaR(95%) = 第5百分位的收益
示例: VaR(95%) = 8.2% → 有95%把握，损失不超过8.2%

前端显示:
  VaR (95%): 8.2%  [进度条: 绿色 0-10%, 黄色 10-15%, 红色 >15%]
  状态: ✅ 在安全范围内
```

#### CVaR (Conditional VaR)
```
定义: 超过VaR的平均损失
计算: CVaR = VaR超出部分的平均值
示例: CVaR(95%) = 11.5% → 最坏5%情况下，平均损失11.5%

前端显示:
  CVaR (95%): 11.5%  [进度条]
  说明: 极端情况下的预期损失
```

#### Sharpe Ratio
```
定义: 风险调整后收益
计算: (收益率 - 无风险利率) / 波动率
示例: 1.85 → 每单位风险获得1.85单位超额收益

前端显示:
  Sharpe Ratio: 1.85  [等级: >2优秀, >1良好, <1较差]
  状态: ✅ 良好
```

#### Max Drawdown
```
定义: 从峰值到谷底的最大跌幅
计算: (谷底 - 峰值) / 峰值
示例: 12.3% → 历史上最大回撤12.3%

前端显示:
  Max Drawdown: 12.3%  [进度条: <10%绿, <20%黄, >20%红]
  状态: ✅ 可接受
```

#### Portfolio Volatility
```
定义: 投资组合收益的标准差
计算: 收益率的标准差
示例: 18.5% → 收益波动性18.5%

前端显示:
  Volatility: 18.5%  [对比: 行业平均20%]
```

#### Correlation Risk
```
定义: 资产间的相关性风险
计算: 高风险资产集中度
示例: 0.65 → 高风险资产占比65%

前端显示:
  Correlation Risk: 0.65  [热图: 资产相关性矩阵]
```

#### Concentration Risk
```
定义: 投资组合集中度
计算: Herfindahl指数
示例: 0.35 → 较分散

前端显示:
  Concentration: 0.35  [饼图: 各资产权重分布]
```

### 2. 实时监控指标

#### 滑点 (Slippage)
```
定义: 实际成交价 vs 预期价格的偏差
计算: (实际价 - 预期价) / 预期价 * 10000 bps
示例: 42 bps = 0.42%

前端显示:
  ┌─ 滑点监控 ─────────────────┐
  │ 平均滑点: 18 bps  ✅       │
  │ 最大滑点: 42 bps  ⚠️       │
  │ 违规次数: 1/3     ⚠️       │
  │                            │
  │ 各资产滑点:                │
  │   BTC:  42 bps [████    ] │
  │   ETH:  25 bps [███     ] │
  │   SOL:  18 bps [██      ] │
  │   ...                      │
  │                            │
  │ [24h滑点趋势图]            │
  └────────────────────────────┘
```

#### 流动性 (Liquidity)
```
定义: 市场深度和交易便利性
计算: 0.4*深度 + 0.3*价差 + 0.3*交易量
示例: 0.72 → 良好流动性

前端显示:
  ┌─ 流动性监控 ───────────────┐
  │ 平均评分: 0.72  ✅         │
  │ 最低评分: 0.58  ⚠️         │
  │ 监控资产: 10    ✅         │
  │                            │
  │ 各资产流动性:              │
  │   USDC: 0.95 [█████████] │
  │   BTC:  0.78 [████████  ] │
  │   ETH:  0.65 [██████    ] │
  │   SOL:  0.52 [█████     ] │
  │   ...                      │
  │                            │
  │ 详细指标:                  │
  │   Bid深度: $125,000        │
  │   Ask深度: $118,000        │
  │   价差:    25 bps          │
  │   24h量:   $2.5M           │
  └────────────────────────────┘
```

#### 异常检测 (Anomaly)
```
类型:
  1. Price Spike - 价格突变
  2. Volume Anomaly - 交易量异常
  3. Liquidity Drain - 流动性骤降

前端显示:
  ┌─ 异常检测 ─────────────────┐
  │ 总计: 2                    │
  │   🚨 Critical: 0           │
  │   🔶 High:     1           │
  │   ⚠️  Medium:   1           │
  │                            │
  │ 最近异常:                  │
  │ ─────────────────────────  │
  │ 14:15 🔶 SOL价格+16%      │
  │   类型: Price Spike        │
  │   严重度: HIGH             │
  │   操作: 已暂停交易         │
  │                            │
  │ 14:08 ⚠️  ETH交易量3.2x    │
  │   类型: Volume Anomaly     │
  │   严重度: MEDIUM           │
  │   操作: 仅警告             │
  │                            │
  │ [24h异常时间线]            │
  └────────────────────────────┘
```

### 3. 警报系统

```
级别:
  🚨 CRITICAL - 立即暂停交易
  ⚠️  WARNING  - 警告，继续监控
  ℹ️  INFO     - 信息性通知

类别:
  SLIPPAGE   - 滑点相关
  LIQUIDITY  - 流动性相关
  ANOMALY    - 异常行为
  PORTFOLIO  - 投资组合风险

前端显示:
  ┌─ 实时警报 ─────────────────┐
  │ 🔴 1 Critical              │
  │ ⚠️  3 Warnings              │
  │ ℹ️  5 Info                  │
  │                            │
  │ 最新警报:                  │
  │ ─────────────────────────  │
  │ 14:32 🚨 BTC滑点超限       │
  │   52 bps > 50 bps          │
  │   操作: 暂停交易           │
  │   [详情] [确认]            │
  │                            │
  │ 14:28 ⚠️  ETH流动性低      │
  │   评分0.48 < 0.5           │
  │   操作: 监控               │
  │   [详情]                   │
  │                            │
  │ [查看全部历史]             │
  └────────────────────────────┘
```

## 🎯 工作流程

### 正常交易流程

```
1. Trading Agent生成Portfolio
   ↓
2. Risk Agent评估
   • 计算所有风险指标
   • VaR ✅ Sharpe ✅ 滑点 ✅ 流动性 ✅
   ↓
3. 批准Portfolio
   ↓
4. Trader执行交易
   ↓
5. 实时监控
   • 每笔交易后检查滑点
   • 持续监控流动性
   • 检测异常行为
   ↓
6. 更新Dashboard
```

### 风险触发流程

```
1. 检测到风险事件
   例: BTC滑点 52 bps
   ↓
2. 生成Critical Alert
   🚨 CRITICAL: BTC滑点超限
   ↓
3. 触发暂停机制
   trading_halted = True
   halt_reason = "高滑点风险"
   ↓
4. 阻止新交易
   Trading Agent被阻止
   ↓
5. Dashboard通知
   🔴 Trading Halted
   显示原因和时间
   ↓
6. 等待人工干预
   [Resume Trading] 按钮
   需要确认风险已解除
```

## 📁 文件结构

```
agents/
  advanced_risk_agent.py      # 高级Risk Agent
  simple_risk_metrics.py      # 风险指标计算

app/
  config.yaml                 # 风险管理配置
  risk_dashboard.py          # Risk Dashboard (待创建)

文档:
  RISK_MANAGEMENT_SYSTEM.md  # 本文档
```

## 🚀 使用方式

### 1. 启用高级Risk Agent

```python
from agents.advanced_risk_agent import AdvancedRiskAgent

risk_agent = AdvancedRiskAgent(config)

# 评估Portfolio
metrics = await risk_agent.assess_portfolio_risk(
    portfolio=portfolio,
    market_data=market_data,
    current_positions=positions
)

# 检查是否暂停
should_halt, reason = await risk_agent.should_halt_trading()

if should_halt:
    print(f"🚨 Trading halted: {reason}")
```

### 2. 实时监控

```python
# 监控滑点
slippage = await risk_agent.monitor_slippage(
    asset="BTC",
    expected_price=109700,
    actual_price=110250
)

# 监控流动性
liquidity = await risk_agent.monitor_liquidity(
    asset="ETH",
    market_data=market_data
)

# 检测异常
anomalies = await risk_agent.detect_anomalies(
    asset="SOL",
    current_price=245,
    market_data=market_data
)
```

### 3. 获取风险报告

```python
report = risk_agent.get_comprehensive_risk_report()

# 报告包含:
# - trading_status
# - slippage统计
# - liquidity统计
# - anomalies统计
# - alerts统计
# - portfolio_risk
```

### 4. Dashboard显示

```python
import streamlit as st

# 显示风险指标
st.metric("VaR (95%)", f"{metrics.var_95*100:.2f}%")
st.metric("Sharpe Ratio", f"{metrics.sharpe_ratio:.2f}")
st.metric("滑点", f"{metrics.avg_slippage_bps:.1f} bps")
st.metric("流动性", f"{metrics.liquidity_score:.2f}")

# 显示警报
for alert in recent_alerts:
    st.warning(f"{alert.level}: {alert.message}")
```

## 🎉 总结

### ✅ 完整功能

1. **Portfolio风险** - 12种风险指标
2. **实时监控** - 滑点、流动性、异常
3. **自动暂停** - 6种触发条件
4. **前端就绪** - 完整Dashboard设计

### 📊 所有风险指标

**Portfolio (12个)**:
- VaR (95%, 99%)
- CVaR (95%, 99%)
- Sharpe, Sortino, Calmar
- Max Drawdown, Volatility
- Correlation, Concentration, Diversification

**实时监控 (8个)**:
- 平均/最大滑点
- 流动性评分/深度/价差
- 异常计数/严重度

**总计**: 20+ 风险指标！

所有指标都会在前端展示！🎯
